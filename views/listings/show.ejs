<% layout("/layouts/boilerplate") %>

<style>
    .page-wrapper { max-width: 100%; padding: 0; margin: 0; }
    .full-width-container { max-width: 100%; padding: 0; margin: 0; background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%); }
    
    .page-header {
        background: linear-gradient(135deg, #003049 0%, #1a5276 50%, #003049 100%);
        padding: 2rem 3rem; margin: 0; border-radius: 0; position: relative; overflow: hidden;
    }
    .page-header::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="2"/></svg>');
        background-size: 200px 200px; opacity: 0.5;
    }
    .page-header h1 { color: white; font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; position: relative; z-index: 1; }
    .page-header p { color: rgba(255,255,255,0.85); font-size: 1rem; position: relative; z-index: 1; }
    
    .form-section { background: white; border-radius: 20px; padding: 2rem; margin-bottom: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.06); border: 1px solid #eee; transition: all 0.3s ease; }
    .form-section:hover { box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
    .section-header { display: flex; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #f0f0f0; }
    .section-icon { width: 50px; height: 50px; background: linear-gradient(135deg, #D62828 0%, #F77F00 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 1rem; color: white; font-size: 1.3rem; }
    .section-title-group h3 { font-size: 1.4rem; font-weight: 700; color: #003049; margin: 0; }
    .section-title-group p { font-size: 0.9rem; color: #666; margin: 0; }
    
    .hero-section { position: relative; margin-bottom: 2rem; }
    .hero-image { width: 100%; height: 60vh; object-fit: cover; border-radius: 0; }
    .hero-gallery { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 4px; height: 60vh; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; overflow: hidden; background: #f0f0f0; }
    .hero-gallery .main-img { grid-row: 1 / 3; width: 100%; height: 100%; object-fit: cover; cursor: pointer; transition: transform 0.3s ease; }
    .hero-gallery .main-img:hover { transform: scale(1.02); }
    .hero-gallery .side-img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; transition: transform 0.3s ease; }
    .hero-gallery .side-img:hover { transform: scale(1.05); }
    .gallery-btn { position: absolute; bottom: 20px; right: 20px; background: white; border: none; border-radius: 8px; padding: 10px 20px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
    .gallery-btn:hover { background: #f0f0f0; transform: translateY(-2px); }
    
    .wishlist-btn { position: absolute; top: 20px; right: 20px; z-index: 100; background: white; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
    .wishlist-btn:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(214, 40, 40, 0.4); }
    .wishlist-btn i { color: #D62828; font-size: 1.3rem; }
    .wishlist-btn.in-wishlist i { color: #D62828; }
    
    .listing-title { font-size: 1.75rem; font-weight: 700; color: #003049; margin-bottom: 0.5rem; }
    .listing-meta { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; color: #444; }
    .listing-meta-item { display: flex; align-items: center; gap: 0.3rem; }
    .listing-meta-item i { color: #D62828; }
    .rating-badge { background: linear-gradient(135deg, #D62828, #F77F00); color: white; padding: 4px 12px; border-radius: 20px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
    
    .stats-row { display: flex; gap: 2rem; padding: 1rem 0; margin: 1rem 0; border-top: 1px solid #eee; border-bottom: 1px solid #eee; }
    .stat-item { display: flex; align-items: center; gap: 0.5rem; color: #444; }
    .stat-item i { color: #003049; font-size: 1.1rem; }
    
    .booking-card { position: sticky; top: 20px; background: white; border-radius: 20px; padding: 1.5rem; box-shadow: 0 8px 32px rgba(0,0,0,0.12); border: 1px solid #eee; }
    .booking-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 1rem; }
    .booking-price { font-size: 1.6rem; font-weight: 700; color: #003049; }
    .booking-price span { font-size: 1rem; font-weight: 400; color: #666; }
    .price-details { color: #666; font-size: 0.9rem; margin-bottom: 1rem; }
    .reserve-btn { background: linear-gradient(135deg, #D62828, #F77F00) !important; border: none !important; border-radius: 50px; padding: 1rem; font-weight: 700; font-size: 1rem; transition: all 0.3s ease; width: 100%; color: white !important; }
    .reserve-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(247, 127, 0, 0.4); }
    .contact-btn { border: 2px solid #003049 !important; border-radius: 50px; color: #003049 !important; font-weight: 600; transition: all 0.3s ease; width: 100%; padding: 0.75rem 1rem; }
    .contact-btn:hover { background: #003049 !important; color: white !important; }
    
    .host-card { background: linear-gradient(135deg, #f8f9fa, #fff); border-radius: 16px; padding: 1.25rem; border: 1px solid #eee; margin-bottom: 1.5rem; }
    .host-info { display: flex; align-items: center; gap: 1rem; }
    .host-avatar { width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #D62828, #F77F00); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.4rem; font-weight: 600; }
    .host-details h4 { margin: 0; font-weight: 600; color: #003049; }
    .host-details p { margin: 0; color: #666; font-size: 0.9rem; }
    
    .amenities-section { margin-bottom: 1.5rem; }
    .amenities-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 1rem; color: #003049; }
    .amenities-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.75rem; }
    .amenity-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; background: linear-gradient(145deg, #fafafa, #f0f0f0); border-radius: 12px; transition: all 0.3s ease; }
    .amenity-item:hover { background: #EAE2B7; transform: translateX(5px); }
    .amenity-item i { color: #D62828; font-size: 1rem; width: 20px; text-align: center; }
    .amenity-item span { font-size: 0.9rem; color: #003049; }
    
    .description-section { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #eee; }
    .description-text { font-size: 1rem; line-height: 1.7; color: #444; }
    
    .reviews-section { margin-top: 1.5rem; }
    .reviews-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .reviews-title { font-size: 1.4rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; color: #003049; }
    .reviews-title i { color: #F77F00; }
    .review-card { background: white; border: 1px solid #eee; border-radius: 16px; padding: 1.5rem; margin-bottom: 1rem; transition: all 0.3s ease; }
    .review-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.08); transform: translateY(-2px); }
    .review-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }
    .review-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #003049, #006d92); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; }
    .review-author { font-weight: 600; color: #003049; font-size: 0.95rem; }
    .review-date { font-size: 0.8rem; color: #888; }
    .review-rating { color: #F77F00; font-size: 0.85rem; }
    .review-comment { color: #555; line-height: 1.6; font-size: 0.95rem; }
    
    .form-control { border-radius: 12px; border: 2px solid #e8e8e8; padding: 0.85rem 1.1rem; transition: all 0.3s ease; background: #fafafa; }
    .form-control:focus { border-color: #003049; box-shadow: 0 0 0 4px rgba(0, 48, 73, 0.1); background: white; outline: none; }
    .form-label { font-weight: 600; color: #003049; margin-bottom: 0.5rem; font-size: 0.95rem; }
    
    .review-form { background: linear-gradient(145deg, #f8f9fa, #fff); padding: 1.5rem; border-radius: 16px; margin-bottom: 1.5rem; border: 1px solid #eee; }
    .review-form h4 { margin-bottom: 1rem; color: #003049; font-weight: 600; }
    .review-form .form-control { border-radius: 12px; border: 2px solid #e8e8e8; padding: 0.85rem 1.1rem; }
    .review-form .form-control:focus { border-color: #D62828; box-shadow: 0 0 0 4px rgba(214, 40, 40, 0.1); }
    .review-form .btn { border-radius: 50px; padding: 0.75rem 2rem; font-weight: 600; }
    .submit-review-btn { background: linear-gradient(135deg, #D62828, #F77F00); border: none; color: white; transition: all 0.3s ease; }
    .submit-review-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(214, 40, 40, 0.4); }
    .starability-slot { margin: 0.5rem 0; }
    
    .modal-content { border-radius: 16px; border: none; }
    .modal-header { border-bottom: 1px solid #eee; border-radius: 16px 16px 0 0; }
    .modal-footer { border-top: 1px solid #eee; }
    
    .availability-badge { padding: 0.35rem 0.85rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
    .availability-badge.available { background: #d4edda; color: #155724; }
    .availability-badge.unavailable { background: #f8d7da; color: #721c24; }
    
    .edit-delete-btns { display: flex; gap: 1rem; margin-top: 1.5rem; padding-top: 1.5rem; padding-bottom: 1.5rem; border-top: 1px solid #eee; flex-wrap: wrap; margin-bottom: 1.5rem; }
    .edit-delete-btns .btn { border-radius: 50px; padding: 0.75rem 1.75rem; font-weight: 600; font-size: 0.95rem; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem; }
    
    /* Edit Listing Button - Gradient Style (matching style.css add-btn, edit-btn colors) */
    .edit-delete-btns .btn-edit-listing {
        background: linear-gradient(135deg, #D62828, #F77F00) !important;
        border: none !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(214, 40, 40, 0.25);
    }
    .edit-delete-btns .btn-edit-listing:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(247, 127, 0, 0.4);
    }
    
    /* Delete Button - Outline Style (using project's red color) */
    .edit-delete-btns .btn-delete-listing {
        background: transparent !important;
        border: 2px solid #D62828 !important;
        color: #D62828 !important;
        font-weight: 600 !important;
    }
    .edit-delete-btns .btn-delete-listing:hover {
        background: #D62828 !important;
        color: white !important;
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(214, 40, 40, 0.35);
    }
    
    /* Confirmation dialog styling */
    .edit-delete-btns .btn-delete-listing.confirm-delete {
        background: #D62828 !important;
        color: white !important;
        animation: pulse 0.5s ease infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .thumbnail-container { display: flex; gap: 8px; padding: 0.75rem 0; overflow-x: auto; }
    .thumbnail-container::-webkit-scrollbar { height: 6px; }
    .thumbnail-container::-webkit-scrollbar-track { background: #f0f0f0; border-radius: 3px; }
    .thumbnail-container::-webkit-scrollbar-thumb { background: #D62828; border-radius: 3px; }
    .thumbnail { width: 70px; height: 55px; object-fit: cover; border-radius: 8px; cursor: pointer; opacity: 0.6; transition: all 0.3s ease; flex-shrink: 0; border: 2px solid transparent; }
    .thumbnail:hover, .thumbnail.active { opacity: 1; border-color: #D62828; box-shadow: 0 2px 8px rgba(214, 40, 40, 0.4); }
    
    @media (max-width: 992px) {
        .hero-image, .hero-gallery { height: 45vh; }
        .booking-card { position: relative; margin-top: 2rem; }
        .page-header { padding: 1.5rem; }
    }
    @media (max-width: 768px) {
        .hero-gallery { grid-template-columns: 1fr 1fr; height: 35vh; }
        .hero-gallery .main-img { grid-row: 1; grid-column: 1 / 3; }
        .hero-image { height: 30vh; }
        .listing-title { font-size: 1.4rem; }
        .stats-row { flex-wrap: wrap; gap: 0.75rem; }
        .stat-item { font-size: 0.9rem; }
        .amenities-grid { grid-template-columns: 1fr; }
        .form-section { padding: 1.5rem; }
        .reviews-title { font-size: 1.2rem; }
        .host-info { flex-direction: column; text-align: center; }
        .edit-delete-btns { flex-direction: column; }
        .edit-delete-btns .btn { width: 100%; text-align: center; }
        .page-header { padding: 1.5rem; }
        .page-header h1 { font-size: 1.5rem; }
    }
    
    .bg-pattern { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; background-image: radial-gradient(circle at 20% 80%, rgba(214, 40, 40, 0.03) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(0, 48, 73, 0.03) 0%, transparent 50%), radial-gradient(circle at 40% 40%, rgba(247, 127, 0, 0.02) 0%, transparent 40%); }
    
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .form-section { animation: fadeInUp 0.5s ease forwards; }
</style>

<% 
// Calculate host since year dynamically
let hostSinceYear = new Date().getFullYear();
if (listing.owner && listing.owner.createdAt) {
    hostSinceYear = new Date(listing.owner.createdAt).getFullYear();
}
%>

<div class="bg-pattern"></div>

<div class="hero-section">
    <% if(listing.images && listing.images.length > 0) { %>
        <div class="hero-gallery">
            <img src="<%= listing.images[0].url %>" class="main-img" alt="Main Image" onclick="openGallery(0)">
            <% if(listing.images.length > 1) { %><img src="<%= listing.images[1].url %>" class="side-img" alt="Image 2" onclick="openGallery(1)"><% } %>
            <% if(listing.images.length > 2) { %><img src="<%= listing.images[2].url %>" class="side-img" alt="Image 3" onclick="openGallery(2)"><% } %>
            <% if(listing.images.length > 3) { %><img src="<%= listing.images[3].url %>" class="side-img" alt="Image 4" onclick="openGallery(3)"><% } %>
        </div>
        <% if(listing.images.length > 4) { %><button class="gallery-btn" onclick="openGallery(0)"><i class="fas fa-images"></i> Show all <%= listing.images.length %> photos</button><% } %>
    <% } else if(listing.image && listing.image.url) { %><img src="<%= listing.image.url %>" class="hero-image" alt="listing_image"><% } else { %><img src="https://via.placeholder.com/1200x600" class="hero-image" alt="listing_image"><% } %>
    
    <% if(currUser) { %>
        <form action="/listings/<%= listing._id %>/wishlist" method="POST" style="position: relative;">
            <button type="submit" class="wishlist-btn <%= typeof isInWishlist !== 'undefined' && isInWishlist ? 'in-wishlist' : '' %>" title="<%= typeof isInWishlist !== 'undefined' && isInWishlist ? 'Remove from wishlist' : 'Add to wishlist' %>">
                <i class="<%= typeof isInWishlist !== 'undefined' && isInWishlist ? 'fas' : 'far' %> fa-heart"></i>
            </button>
        </form>
    <% } %>
</div>

<div class="full-width-container">
    
    <div class="container-fluid px-4" style="max-width: 1400px; margin: 0 auto;">
        <div class="row">
            <div class="col-lg-8">
                <div class="form-section">
                    <h1 class="listing-title"><%= listing.title %></h1>
                    <div class="listing-meta">
                        <div class="listing-meta-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span><%= listing.location %>, <%= listing.country %></span>
                        </div>
                    </div>
                    <div class="stats-row" style="border: none; margin: 0; padding: 0;">
                        <% if(listing.guests) { %><div class="stat-item"><i class="fas fa-users"></i><span><%= listing.guests %> guests</span></div><% } %>
                        <% if(listing.bedrooms) { %><div class="stat-item"><i class="fas fa-bed"></i><span><%= listing.bedrooms %> bedrooms</span></div><% } %>
                        <% if(listing.beds) { %><div class="stat-item"><i class="fas fa-bed"></i><span><%= listing.beds %> beds</span></div><% } %>
                        <% if(listing.baths) { %><div class="stat-item"><i class="fas fa-bath"></i><span><%= listing.baths %> baths</span></div><% } %>
                        <% if(listing.avgRating > 0) { %><div class="rating-badge"><i class="fas fa-star"></i><span><%= listing.avgRating.toFixed(1) %> · <%= listing.reviews.length %> reviews</span></div><% } %>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="section-header" style="border: none; padding: 0; margin: 0;">
                        <div class="section-icon"><i class="fas fa-user"></i></div>
                        <div class="section-title-group">
                            <h3>Hosted by <%= listing.owner ? listing.owner.username : 'Unknown' %></h3>
                            <p>Host since <%= hostSinceYear %> · Superhost</p>
                        </div>
                    </div>
                </div>
                
                <div class="form-section description-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-info-circle"></i></div>
                        <div class="section-title-group">
                            <h3>About this place</h3>
                            <p>What makes this place special</p>
                        </div>
                    </div>
                    <p class="description-text"><%= listing.description %></p>
                    <% if(listing.availability) { %>
                        <div class="mt-3">
                            <i class="fas fa-calendar-alt" style="color: #D62828;"></i>
                            <strong>Min:</strong> <%= listing.availability.minNights %> nights · <strong>Max:</strong> <%= listing.availability.maxNights %> nights
                            <% if(listing.availability.available) { %><span class="availability-badge available ms-2"><i class="fas fa-check"></i> Available</span><% } else { %><span class="availability-badge unavailable ms-2"><i class="fas fa-times"></i> Not Available</span><% } %>
                        </div>
                    <% } %>
                </div>
                
                <% if(listing.amenities && listing.amenities.length > 0) { %>
                    <div class="form-section amenities-section">
                        <div class="section-header">
                            <div class="section-icon"><i class="fas fa-concierge-bell"></i></div>
                            <div class="section-title-group">
                                <h3>What this place offers</h3>
                                <p>Features and amenities</p>
                            </div>
                        </div>
                        <div class="amenities-grid">
                            <% for(let amenity of listing.amenities) { %><div class="amenity-item"><i class="fas fa-check-circle"></i><span><%= amenity %></span></div><% } %>
                        </div>
                    </div>
                <% } %>
                
                <div class="form-section reviews-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-star"></i></div>
                        <div class="section-title-group">
                            <h3><%= listing.reviews.length %> Reviews</h3>
                            <p>What guests say about their stay</p>
                        </div>
                    </div>
                    
                    <% if(currUser) { %>
                        <div class="review-form">
                            <h4><i class="fas fa-pen"></i> Leave a Review</h4>
                            <form action="/listings/<%= listing._id %>/reviews" method="POST" class="needs-validation" novalidate>
                                <div class="mb-3">
                                    <label class="form-label">Rating</label>
                                    <fieldset class="starability-slot">
                                        <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating." />
                                        <input type="radio" id="first-rate1" name="review[rating]" value="1" /><label for="first-rate1" title="Terrible">1 star</label>
                                        <input type="radio" id="first-rate2" name="review[rating]" value="2" /><label for="first-rate2" title="Not good">2 stars</label>
                                        <input type="radio" id="first-rate3" name="review[rating]" value="3" /><label for="first-rate3" title="Average">3 stars</label>
                                        <input type="radio" id="first-rate4" name="review[rating]" value="4" /><label for="first-rate4" title="Very good">4 stars</label>
                                        <input type="radio" id="first-rate5" name="review[rating]" value="5" /><label for="first-rate5" title="Amazing">5 stars</label>
                                    </fieldset>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Your Review</label>
                                    <textarea name="review[comment]" id="comment" cols="30" rows="4" class="form-control" required placeholder="Share your experience at this place..."></textarea>
                                    <div class="invalid-feedback">Please share your thoughts</div>
                                </div>
                                <button type="submit" class="btn submit-review-btn"><i class="fas fa-paper-plane"></i> Submit Review</button>
                            </form>
                        </div>
                    <% } %>
                    
                    <% if(listing.reviews && listing.reviews.length > 0) { %>
                        <div class="reviews-list">
                            <% for(review of listing.reviews) { %>
                                <div class="review-card">
                                    <div class="review-header">
                                        <div class="review-avatar"><%= review.author && review.author.username ? review.author.username.charAt(0).toUpperCase() : 'U' %></div>
                                        <div>
                                            <div class="review-author">@<%= review.author && review.author.username ? review.author.username : 'Unknown' %></div>
                                            <div class="review-date">
                                                <%= review.created ? new Date(review.created).toLocaleDateString() : 'Recently' %>
                                                <% if(review.rating) { %><span class="review-rating"> · <i class="fas fa-star"></i> <%= review.rating %>/5</span><% } %>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="review-comment"><%= review.comment %></p>
                                    <% if(currUser && review.author && review.author._id && currUser._id && review.author._id.equals(currUser._id)) { %>
                                        <form method="post" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" class="mt-2"><button class="btn btn-sm btn-outline-danger">Delete Review</button></form>
                                    <% } %>
                                </div>
                            <% } %>
                        </div>
                    <% } else { %>
                        <div class="text-center py-4"><i class="fas fa-comments" style="font-size: 3rem; color: #ccc;"></i><p class="text-muted mt-2">No reviews yet. Be the first to review!</p></div>
                    <% } %>
                </div>
                
                <% if(currUser && listing.owner && listing.owner._id.equals(currUser._id)){ %>
                    <div class="edit-delete-btns">
                        <a href="/listings/<%= listing._id %>/edit" class="btn btn-edit-listing"><i class="fas fa-edit"></i> Edit Listing</a>
                        <form method="post" action="/listings/<%= listing._id %>?_method=DELETE" class="d-inline" id="deleteForm">
                            <button type="submit" class="btn btn-delete-listing" onclick="confirmDelete(event, this)"><i class="fas fa-trash"></i> Delete</button>
                        </form>
                    </div>
                <% } %>
            </div>
            
            <div class="col-lg-4">
                <div class="booking-card">
                    <div class="booking-header">
                        <div><span class="booking-price">₹<%= listing.price ? listing.price.toLocaleString("en-IN") : 0 %></span><span>/ night</span></div>
                    </div>
                    <p class="price-details mb-3"><i class="fas fa-info-circle"></i> You won't be charged yet</p>
                    
                    <% if(currUser && listing.owner && !listing.owner._id.equals(currUser._id) && listing.availability && listing.availability.available !== false) { %>
                        <form action="/listings/<%= listing._id %>/book" method="POST" id="bookingForm">
                            <div class="mb-3"><label class="form-label">Check-in</label><input type="date" class="form-control" name="checkIn" id="checkIn" required></div>
                            <div class="mb-3"><label class="form-label">Check-out</label><input type="date" class="form-control" name="checkOut" id="checkOut" required></div>
                            <div class="mb-3"><label class="form-label">Guests</label><select class="form-control" name="guests"><% for(let i = 1; i <= (listing.guests || 10); i++) { %><option value="<%= i %>"><%= i %> <%= i === 1 ? 'guest' : 'guests' %></option><% } %></select></div>
                            <div class="mb-3"><label class="form-label">Your Name</label><input type="text" class="form-control" name="guestName" required placeholder="Full name"></div>
                            <div class="mb-3"><label class="form-label">Email</label><input type="email" class="form-control" name="guestEmail" required placeholder="your@email.com"></div>
                            <div class="mb-3"><label class="form-label">Phone</label><input type="tel" class="form-control" name="guestPhone" required placeholder="Phone number"></div>
                            <div class="mb-3"><label class="form-label">Special Requests (optional)</label><textarea class="form-control" name="specialRequests" rows="2" placeholder="Any special requests?"></textarea></div>
                            <button type="submit" class="btn reserve-btn"><i class="fas fa-calendar-check"></i> Reserve</button>
                        </form>
                        <button class="btn contact-btn mt-3" data-bs-toggle="modal" data-bs-target="#contactModal"><i class="fas fa-envelope"></i> Contact Host</button>
                    <% } else if(!currUser) { %>
                        <a href="/login" class="btn reserve-btn text-center"><i class="fas fa-sign-in-alt"></i> Login to Book</a>
                    <% } else if(listing.availability && listing.availability.available === false) { %>
                        <div class="alert alert-danger text-center"><i class="fas fa-ban"></i> This listing is not available for booking</div>
                    <% } %>
                    
                    <div class="text-center mt-3"><small class="text-muted"><i class="fas fa-shield-alt"></i> Free cancellation up to 24h before check-in</small></div>
                </div>
            </div>
        </div>
    </div>
</div>

<% if(currUser && listing.owner) { %>
<div class="modal fade" id="contactModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-envelope" style="color: #D62828;"></i> Contact Host</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="/messages/send" method="POST">
                <input type="hidden" name="recipientId" value="<%= listing.owner._id %>">
                <input type="hidden" name="listingId" value="<%= listing._id %>">
                <div class="modal-body">
                    <div class="form-group mb-3"><label>Subject</label><input type="text" class="form-control" name="subject" placeholder="Inquiry about <%= listing.title %>" required></div>
                    <div class="form-group"><label>Message</label><textarea class="form-control" name="body" rows="4" placeholder="Write your message to the host..." required></textarea></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Message</button>
                </div>
            </form>
        </div>
    </div>
</div>
<% } %>

<script>
    function changeImage(url, thumbnail) {
        const mainImg = document.querySelector('.main-img');
        if (mainImg) mainImg.src = url;
        document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
        thumbnail.classList.add('active');
    }
    function openGallery(index) { console.log('Open gallery at index:', index); }
    
    // Delete confirmation function
    function confirmDelete(event, button) {
        event.preventDefault();
        if (button.classList.contains('confirm-delete')) {
            // Second click - submit the form
            button.closest('form').submit();
        } else {
            // First click - ask for confirmation
            button.classList.add('confirm-delete');
            button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Confirm Delete';
            // Reset after 3 seconds if not clicked again
            setTimeout(() => {
                button.classList.remove('confirm-delete');
                button.innerHTML = '<i class="fas fa-trash"></i> Delete';
            }, 3000);
        }
    }
    
    // Booking calendar - fetch unavailable dates from backend
    (function() {
        const checkInInput = document.getElementById('checkIn');
        const checkOutInput = document.getElementById('checkOut');
        const listingId = '<%= listing._id %>';
        let unavailableDates = [];
        
        // Fetch unavailable dates from backend
        async function fetchUnavailableDates() {
            try {
                const response = await fetch(`/listings/${listingId}/availability`);
                const data = await response.json();
                if (data.unavailableDates) {
                    unavailableDates = data.unavailableDates.map(d => new Date(d));
                }
                configureDatePickers();
            } catch (error) {
                console.error('Error fetching unavailable dates:', error);
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                checkInInput.min = tomorrow.toISOString().split('T')[0];
                checkOutInput.min = tomorrow.toISOString().split('T')[0];
            }
        }
        
        function configureDatePickers() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            checkInInput.min = tomorrowStr;
            checkOutInput.min = tomorrowStr;
            
            checkInInput.addEventListener('change', function() {
                if (this.value) {
                    const checkInDate = new Date(this.value);
                    const minCheckOut = new Date(checkInDate);
                    minCheckOut.setDate(minCheckOut.getDate() + 1);
                    
                    if (minCheckOut < tomorrow) {
                        minCheckOut = tomorrow;
                        minCheckOut.setDate(minCheckOut.getDate() + 1);
                    }
                    
                    checkOutInput.min = minCheckOut.toISOString().split('T')[0];
                    
                    if (checkOutInput.value && new Date(checkOutInput.value) <= checkInDate) {
                        checkOutInput.value = minCheckOut.toISOString().split('T')[0];
                    }
                }
            });
        }
        
        if (checkInInput && checkOutInput) {
            fetchUnavailableDates();
        }
        
        const bookingForm = document.getElementById('bookingForm');
        if (bookingForm) {
            bookingForm.addEventListener('submit', function(e) {
                const checkIn = new Date(this.checkIn.value);
                const checkOut = new Date(this.checkOut.value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (checkIn < today) { 
                    e.preventDefault(); 
                    alert('Check-in date cannot be in the past'); 
                    return; 
                }
                if (checkOut <= checkIn) { 
                    e.preventDefault(); 
                    alert('Check-out must be after check-in'); 
                    return; 
                }
                
                let currentDate = new Date(checkIn);
                while (currentDate < checkOut) {
                    const isUnavailable = unavailableDates.some(unavailable => 
                        unavailable.toDateString() === currentDate.toDateString()
                    );
                    if (isUnavailable) {
                        e.preventDefault();
                        alert('Some dates in your selection are not available. Please choose different dates.');
                        return;
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            });
        }
    })();
</script>
</parameter>
</invoke>
